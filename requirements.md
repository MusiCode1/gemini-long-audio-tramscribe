### **מסמך דרישות מערכת - אפליקציית תמלול אודיו**

**1. חזון ומטרה כללית**
המערכת מיועדת לספק תמלול איכותי, מדויק וקריא של קבצי אודיו ארוכים בשפה העברית, עם התמחות בשיעורי תורה והרצאות. המערכת תשתמש ביכולות המתקדמות של מודל Gemini של גוגל כדי להשיג מטרה זו, ותספק חווית משתמש פשוטה, ברורה ואמינה. כל העיבוד יתבצע בצד הלקוח (בדפדפן) כדי להבטיח פרטיות ופשטות ארכיטקטונית.

**2. דרישות פונקציונליות ליבה**

*   **2.1 העלאת קובץ:**
    *   המערכת תאפשר למשתמש להעלות קובץ אודיו בודד.
    *   יתמכו פורמטים נפוצים: `MP3`, `WAV`, `M4A`, `FLAC`, ו-`MP4` (אודיו).
    *   ממשק ההעלאה יתמוך הן בבחירת קובץ דרך סייר הקבצים והן בגרירה ושחרור (Drag and Drop).
    *   המערכת תבצע ולידציה של סוג הקובץ ותציג שגיאה ברורה אם הפורמט אינו נתמך.

*   **2.2 פיצול אודיו למקטעים (Chunking):**
    *   **דרישה:** קבצי אודיו שאורכם עולה על משך זמן מוגדר (כרגע 20 דקות) **חייבים** להיות מחולקים למקטעים קטנים יותר.
    *   **רציונל:** דרישה זו אינה נובעת ממגבלת העלאה טכנית של ה-API, אלא ממגבלה תפעולית של מודל Gemini. קבצים ארוכים מדי עלולים לגרום למודל "להתבלבל", לדלג על קטעים, או להמציא תוכן (hallucinate). חיתוך למקטעים מבטיח עיבוד איכותי ואמין יותר.
    *   כל מקטע (למעט האחרון) יכלול אזור חפיפה (overlap) עם המקטע שאחריו (כרגע 30 שניות). חפיפה זו חיונית לשלב איחוי התמלולים.

*   **2.3 עיבוד ותמלול (Gemini API):**
    *   עבור **כל מקטע אודיו בנפרד**, התהליך יהיה כדלקמן:
        1.  **העלאה:** המקטע יועלה לשרתי גוגל באמצעות ה-**File API** של `@google/genai`.
        2.  **תמלול:** תשלח בקשת `generateContent` למודל `gemini-2.5-flash`. הבקשה תכלול:
            *   הפניה לקובץ שהועלה (`fileUri`).
            *   פרומפט מערכת מפורט (`prompts/transcribe.md`) המנחה את המודל כיצד לתמלל.
        3.  **קבלת תוצאה:** המערכת תקבל את התמלול הטקסטואלי עבור המקטע.
        4.  **ניקוי:** מיד לאחר קבלת התמלול, המערכת **חייבת** לשלוח בקשה למחיקת קובץ המקטע משרתי גוגל (`ai.files.delete`) כדי למנוע הצטברות קבצים ועלויות מיותרות.

*   **2.4 איחוי תמלולים (Stitching):**
    *   לאחר שכל המקטעים תומללו, המערכת תאחה את כל חלקי הטקסט לתמלול אחד רציף.
    *   תהליך האיחוי יתבסס על מציאת החפיפה הארוכה ביותר בין סוף התמלול הקודם לתחילת התמלול החדש, כדי להבטיח מעבר חלק ולמנוע כפילויות.

*   **2.5 הצגת תוצאות ופעולות:**
    *   התמלול הסופי יוצג בשדה טקסט גדול וקריא (`textarea`).
    *   המשתמש יוכל לבצע את הפעולות הבאות על התוצאה:
        *   העתקה ללוח (Copy to Clipboard).
        *   הורדה כקובץ טקסט (`.txt`).
        *   התחלת תהליך חדש עם קובץ אחר (איפוס).

**3. דרישות טכניות וארכיטקטורה**

*   **3.1 אחסון מקומי:**
    *   מקטעי האודיו שנוצרו **חייבים** להישמר ב-`IndexedDB` בדפדפן המשתמש.
    *   **רציונל:** שימוש ב-`IndexedDB` במקום בזיכרון ה-RAM מונע קריסות דפדפן בעת עיבוד קבצים גדולים מאוד ומפחית באופן דרמטי את טביעת הרגל של הזיכרון.
    *   כל המקטעים יימחקו אוטומטית מ-`IndexedDB` בסיום התהליך (בהצלחה או בכישלון) כדי לפנות מקום.

*   **3.2 עיבוד אודיו:**
    *   המערכת תשתמש ב-`AudioContext` של הדפדפן כדי לפענח את קובץ האודיו המקורי.
    *   במידה והאודיו הוא סטריאו, הוא יומר למונו לפני החיתוך והשליחה.
    *   כל מקטע יישמר ויועלה בפורמט WAV, שהוא פורמט לא דחוס המבטיח איכות מקסימלית.

*   **3.3 ממשק API וספריות:**
    *   האינטגרציה עם Gemini תתבצע באמצעות ספריית `@google/genai` הרשמית.
    *   מפתח ה-API ינוהל באמצעות משתנה סביבה (`process.env.API_KEY`).
    *   ניהול מצב האפליקציה יתבצע באמצעות React Hooks.

**4. דרישות ממשק משתמש (UI) וחווית משתמש (UX)**

*   **4.1 עיצוב כללי:**
    *   הממשק יהיה נקי, מודרני ויותאם למכשירים ניידים (Responsive).
    *   העיצוב יתבסס על ערכת נושא כהה (Dark Theme) ותמיכה מלאה בכיווניות מימין-לשמאל (RTL).

*   **4.2 משוב בזמן אמת:**
    *   במהלך כל שלבי העיבוד, המשתמש יקבל משוב ויזואלי ברור על המתרחש.
    *   יוצג שם הקובץ המעובד.
    *   תוצג הודעת סטטוס דינמית המתארת את הפעולה הנוכחית (למשל, "מכין את האודיו...", "מעלה מקטע 3/10...").
    *   יוצג סרגל התקדמות שישקף את מספר המקטעים שכבר עובדו מתוך הסך הכולל.
    *   יוצג "יומן פעילות" (`LogViewer`) שיציג פירוט טכני יותר של כל שלב בתהליך, לשקיפות מלאה.

*   **4.3 טיפול בשגיאות:**
    *   במקרה של שגיאה בכל שלב, התהליך ייעצר.
    *   תוצג למשתמש הודעת שגיאה ברורה ואינפורמטיבית בעברית.
    *   יומן הפעילות יציג את הלוגים שהובילו לשגיאה כדי לסייע באיתור הבעיה.
    *   יוצג כפתור "נסה שוב" שיאפס את המערכת ויאפשר למשתמש להתחיל מחדש.

**5. דרישות תצורה (Configuration)**

*   **5.1 פרומפט מערכת:**
    *   ההוראות למודל Gemini ייטענו מקובץ `Markdown` חיצוני (`prompts/transcribe.md`).
    *   **רציונל:** גישה זו מאפשרת לעדכן ולשפר את ההנחיות למודל בקלות, ללא צורך בשינוי קוד המקור של האפליקציה.

*   **5.2 קבועים (Constants):**
    *   פרמטרים מרכזיים של תהליך העיבוד, כגון אורך המקטע (`CHUNK_DURATION_MIN`) ומשך החפיפה (`OVERLAP_DURATION_MIN`), יוגדרו בקובץ קונפיגורציה ייעודי (`constants.ts`) כדי לאפשר כיול ושינוי קל שלהם.